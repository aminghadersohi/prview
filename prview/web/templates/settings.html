{% extends "base.html" %}

{% block title %}prview - Settings{% endblock %}

{% block extra_head %}
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block nav_settings %}active{% endblock %}

{% block main_attrs %}style="max-width: 900px;"{% endblock %}

{% block content %}
    <h1 class="page-title">&#x2699;&#xFE0F; Settings</h1>

    {% if request.query_params.get('saved') %}
    <div class="alert success">
        &#x2713; Settings saved successfully! Changes will take effect on the next sync.
    </div>
    {% endif %}

    <!-- GitHub Connection Status -->
    <div class="card">
        <div class="card-header">
            &#x1F517; GitHub Connection
        </div>
        <div class="card-body">
            {% if auth_status.authenticated %}
            <div class="auth-info">
                <div class="auth-row">
                    <span class="auth-label">Status</span>
                    <span class="status-badge success">
                        <span class="status-dot"></span>
                        Connected
                    </span>
                </div>
                <div class="auth-row">
                    <span class="auth-label">Host</span>
                    <span class="auth-value hostname">{{ auth_status.hostname or 'github.com' }}</span>
                </div>
                <div class="auth-row">
                    <span class="auth-label">Username</span>
                    <span class="auth-value username">{{ auth_status.username or 'Unknown' }}</span>
                </div>
                {% if auth_status.scopes %}
                <div class="auth-row">
                    <span class="auth-label">Scopes</span>
                    <div class="scopes-list">
                        {% for scope in auth_status.scopes %}
                        <span class="scope-tag">{{ scope }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="alert error">
                {{ auth_status.error or 'Not authenticated' }}
            </div>
            <p style="margin-top: 12px; color: var(--text-secondary);">
                To authenticate, run this command in your terminal:
            </p>
            <div class="code-block" style="margin-top: 8px;">
                gh auth login
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Environment Variables -->
    <div class="card">
        <div class="card-header">
            &#x1F30D; Environment Variables
        </div>
        <div class="card-body">
            <p style="margin-bottom: 16px; color: var(--text-secondary);">
                These environment variables can override the default gh CLI behavior.
                If not set, gh uses its stored credentials.
            </p>
            <table class="env-table">
                <thead>
                    <tr>
                        <th>Variable</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for env in env_vars %}
                    <tr>
                        <td><span class="env-name">{{ env.name }}</span></td>
                        <td>
                            {% if env.is_set %}
                            <span class="env-value env-set">{{ env.value_preview }}</span>
                            {% else %}
                            <span class="env-value env-unset">Not set</span>
                            {% endif %}
                        </td>
                        <td class="env-desc">{{ env.description }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Claude AI Assistant -->
    <div class="card">
        <div class="card-header">
            &#x1F4AC; Claude AI Assistant
        </div>
        <div class="card-body">
            <div class="auth-info" style="margin-bottom: 16px;">
                <div class="auth-row">
                    <span class="auth-label">Status</span>
                    {% if claude_status.available %}
                    <span class="status-badge success">
                        <span class="status-dot"></span>
                        Connected (v{{ claude_status.version or 'unknown' }})
                    </span>
                    {% else %}
                    <span class="status-badge error">
                        <span class="status-dot"></span>
                        Not Available
                    </span>
                    {% endif %}
                </div>
                {% if claude_status.path %}
                <div class="auth-row">
                    <span class="auth-label">Path</span>
                    <span class="auth-value" style="color: var(--text-secondary);">{{ claude_status.path }}</span>
                </div>
                {% endif %}
                {% if claude_status.error %}
                <div class="auth-row">
                    <span class="auth-label">Error</span>
                    <span style="color: var(--error);">{{ claude_status.error }}</span>
                </div>
                {% endif %}
            </div>
            <p style="margin-bottom: 12px; color: var(--text-secondary);">
                Default model for the <a href="/chat" style="color: var(--accent-cyan);">Chat</a> page.
                You can also override the model per-request from the chat interface.
            </p>
            <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Default Model</label>
                <select name="claude_model" class="form-input" form="settings-form">
                    {% for model in claude_models %}
                    <option value="{{ model.id }}" {% if model.id == config.get('claude_model', 'claude-sonnet-4-20250514') %}selected{% endif %}>
                        {{ model.name }} &mdash; {{ model.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Filter Configuration -->
    <div class="card">
        <div class="card-header">
            &#x1F50D; Filter Configuration
        </div>
        <div class="card-body">
            <div class="config-path">
                <span class="config-path-icon">&#x1F4C4;</span>
                {{ config_path }}
            </div>

            <form id="settings-form" action="/settings/save" method="post" style="margin-top: 20px;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Include Organizations</label>
                        <textarea name="include_orgs" class="form-textarea" placeholder="my-org&#10;another-org">{{ config.get('include_orgs', []) | join('\n') }}</textarea>
                        <p class="form-hint">One organization per line. Shows PRs from all repos in these orgs.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exclude Organizations</label>
                        <textarea name="exclude_orgs" class="form-textarea" placeholder="archived-org">{{ config.get('exclude_orgs', []) | join('\n') }}</textarea>
                        <p class="form-hint">One organization per line. Hide PRs from these orgs.</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Include Repositories</label>
                        <textarea name="include_repos" class="form-textarea" placeholder="owner/repo&#10;org/specific-repo">{{ config.get('include_repos', []) | join('\n') }}</textarea>
                        <p class="form-hint">One repository per line (owner/repo format).</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Exclude Repositories</label>
                        <textarea name="exclude_repos" class="form-textarea" placeholder="owner/archived-repo">{{ config.get('exclude_repos', []) | join('\n') }}</textarea>
                        <p class="form-hint">One repository per line. Hide PRs from these repos.</p>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Refresh Interval (seconds)</label>
                        <input type="number" name="refresh_interval" class="form-input" value="{{ config.get('refresh_interval', 60) }}" min="10" max="600">
                        <p class="form-hint">How often to sync PR data (10-600 seconds).</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max PRs per Repository</label>
                        <input type="number" name="max_prs_per_repo" class="form-input" value="{{ config.get('max_prs_per_repo', 10) }}" min="1" max="50">
                        <p class="form-hint">Limit PRs shown per repo (1-50).</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" name="show_drafts" {% if config.get('show_drafts', True) %}checked{% endif %}>
                        <span>Show draft PRs</span>
                    </label>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary">
                        &#x1F4BE; Save Settings
                    </button>
                    <a href="/" class="btn">
                        &#x2190; Back to Dashboard
                    </a>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
